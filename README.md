# Краткое описание работы алгоритма беспарольной двухфакторной аутентификации 
Пользователь вставляет в USB порт токен аутентификации. Далее вводит логин. После нажимает на кнопку на токене. Если все криптографические операции пройдут успешно, то польззователь получит доступ в систему. Также есть количество попыток аутентификации, после исчерпания которых доступ будет запрещен к компьютеру. Например, если пользователь 10 раз неправильно аутентифицируется, то доступ будет запрещен. Такое возможно, если произошла разсинхронизация счётчиков на токене и сервере или проверка подписи на сервере неверна.  

# Описание работы библиотеки libsdk_for_token.so 
Данная библиотека предназначена для локальной двухфакторной аутентификации пользователя с помощью токена при входе в ОС Unix.
Для добовления данного метода аутентификации небходимо создать файл-конфиг в папке `/usr/share/pam-configs`, например с названием `token`.


Файл будет иметь следующие содержание:
```sh
Name: Token
Default: yes
Priority: 800
Auth-Type: Primary
Auth: sufficient /home/libsdk_for_token.so /home/user.json 192.168.1.112 15000
```
`sufficient` - показывает, что данный модуль является необязательным для аутентификации. То есть, если у пользователя не будет доступа к токену, то он всегда сможет использовать пароль для входа в систему. Однако можно сделать этот модуль обязательным. Выбор данного параметра осуществялется администратором сети. 

`/home/libsdk_for_token.so` - путь к библиотеке. 
`/home/user.json` - путь к файлу с ключами для ЭЦП.
`192.168.1.112 15000` - адрес сервера аутентификации и значение таймаута в мс. (отведенное время, которое небходимо для взаимодействия пользователя с токеном)  

Описание файла `user.json`:
```sh
{
    "vas": "657B4A9D2837DD05D7B1F19588BDFC015F923BE3E356AC242ED194563F47F139"
}
```
В файле содержится словарь, где ключ - это имя пользователя, а значение - это закрытый ключ алгоритма ГОСТ 34.10-2012.

Для включения модуля аутентификации небходимо выполнить команду от root и выбрать соответсвующий модуль с помощью пробела в появившемся меню:
```sh
pam-auth-update
```
![image](https://github.com/vas-vas777/pam_library/assets/22542205/ab40656b-625d-40b7-9af9-c521f6394c13)
Затем перезагрузить систему.

# Описание сервера аутентификации
На сервере аутентификации находится файл с пользователями:
```sh
{
"8899aabbccddeeff0011223344556677FEDCBA98765432100123456789ABCDEE": {},
  "8899aabbccddeeff0011223344556677FEDCBA98765432100123456789ABCDEA": {},
  "8899aabbccddeeff0011223344556677FEDCBA98765432100123456789ABCDE8": {},
  "6262303167616b776a6e687538683275353031756f6b6c786c6972676f317778":
  {"vasily": ["B5FEA027B6A4B86038764F70E4EA8B68F66201F88B890BD19DB7B009E3253E3347DD372F9D05E56ADF5A8C6A484A4BE3D27025067BD5F33A6D8522A67B23208F", 2]},
  "8899aabbccddeeff0011223344556677FEDCBA98765432100123456789ABCDEF":
  {"vas": ["D38D702EB301A2858D4429CB94DDB1D48DD5EB6DC2E8D8A4492FDF9E0CAB393DB83611CE3D2166DF000D3E93D37245669FE839135A5A113E8F37EB6BD999C4ED", 96]}
}
```
В данном словаре "ключом" является ключ симметричного алгоритма шифрования ГОСТ 34.12-2018 "Кузнечик". Значение - это список из открытого ключа ЭЦП и счетчика (числовое значение > 0). Значение счётчика - это число успешных аутентификаций.

Для создания ключей ЭЦП на компьютере пользователя не надо пользоваться сторонними программами. Необходимо загрузить конфиг токена и указать где будет храниться файл user.json. Перезагрузиться и зайти с помощью токена. После успешной аутентификации 
файл с ключами автоматически появится на компьютере пользователя в указанной папке, а на сервере появится соответствующая запись с публичным ключом.   
